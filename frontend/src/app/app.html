<div class="container">
  <h1>Prova de Recrutamento Global Tech Holding (Sólides) - Lucas Santana</h1>
  <h2>Cadastro de Pessoas com Django e Angular</h2>

  @if (mensagem()) {
    <div class="alert" 
         [class.alert-success]="tipoMensagem() === 'success'" 
         [class.alert-error]="tipoMensagem() === 'error'">
      {{ mensagem() }}
    </div>
  }

  <div class="form-group search-group">
    <label for="id_pesquisa">Pesquisar por ID:</label>
    <input type="number" id="id_pesquisa" [formControl]="idPesquisaControl" placeholder="Digite o ID">
    <button (click)="onPesquisar()" [disabled]="!idPesquisaControl.value">
      Pesquisar
    </button>
  </div>

  <hr>

  <form [formGroup]="pessoaForm" (ngSubmit)="onIncluir()">
    
    @if (pessoaEncontrada()) {
      <div class="form-group">
        <label for="id">ID:</label>
        <input type="text" id="id" formControlName="id" readonly>
      </div>
    }

    <div class="form-group">
      <label for="nome">Nome:</label>
      <input type="text" id="nome" formControlName="nome" required>
      @if (pessoaForm.get('nome')?.invalid && pessoaForm.get('nome')?.touched) {
        <div class="error-message">
          Nome é obrigatório.
        </div>
      }
    </div>

    <div class="form-group">
      <label for="data_nasc">Data de Nascimento:</label>
      <input type="date" id="data_nasc" formControlName="data_nasc" required>
      @if (pessoaForm.get('data_nasc')?.invalid && pessoaForm.get('data_nasc')?.touched) {
        <div class="error-message">
          A data de nascimento é obrigatória.
        </div>
      }
    </div>

    <div class="form-group">
      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" formControlName="cpf" required placeholder="123.456.789-00" maxlength="14">
      @if (pessoaForm.get('cpf')?.errors?.['required'] && pessoaForm.get('cpf')?.touched) {
        <div class="error-message">
          O CPF é obrigatório.
        </div>
      }
      @if (pessoaForm.get('cpf')?.errors?.['pattern'] && pessoaForm.get('cpf')?.touched) {
        <div class="error-message">
          Formato de CPF inválido. Precisa ser XXX.XXX.XXX-XX
        </div>
      }
    </div>

    <div class="form-group">
      <label for="sexo">Sexo:</label>
      <select id="sexo" formControlName="sexo" required>
        <option [ngValue]="null" disabled>Selecione...</option>
        <option value="M">Masculino</option>
        <option value="F">Feminino</option>
      </select>
      @if (pessoaForm.get('sexo')?.invalid && pessoaForm.get('sexo')?.touched) {
        <div class="error-message">
          Sexo é obrigatório.
        </div>
      }
    </div>

    <div class="form-group">
      <label for="altura">Altura (m):</label>
      <input type="number" id="altura" formControlName="altura" required step="0.01" placeholder="Ex: 1.75">
      @if (pessoaForm.get('altura')?.invalid && pessoaForm.get('altura')?.touched) {
        <div class="error-message">
          Altura é obrigatória (ex: 1.75).
        </div>
      }
    </div>

    <div class="form-group">
      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso" formControlName="peso" required step="0.1" placeholder="Ex: 70.5">
      @if (pessoaForm.get('peso')?.invalid && pessoaForm.get('peso')?.touched) {
        <div class="error-message">
          Peso é obrigatório (ex: 70.5).
        </div>
      }
    </div>

    <div class="button-group">
      <button type="submit" class="btn-primary" [disabled]="pessoaForm.invalid || !!pessoaEncontrada()">
        Incluir
      </button>

      <button type="button" class="btn-secondary" (click)="onAlterar()" [disabled]="pessoaForm.invalid || !pessoaEncontrada()">
        Alterar
      </button>

      <button type="button" class="btn-danger" (click)="onExcluir()" [disabled]="!pessoaEncontrada()">
        Excluir
      </button>

      <button type="button" class="btn-info" (click)="onCalcularPesoIdeal()" [disabled]="!pessoaEncontrada()">
        Calcular Peso Ideal
      </button>
    </div>

  </form>

  @if (pesoIdealPopup()) {
    <div class="modal-overlay" (click)="fecharPopup()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Peso Ideal Calculado</h2>
        
        @if (pessoaEncontrada(); as pessoa) {
          <p>O peso ideal para <strong>{{ pessoa.nome }}</strong> 
             (sexo: {{ pessoa.sexo === 'M' ? 'Masculino' : 'Feminino' }}, 
             altura: {{ pessoa.altura }}m) 
             é:</p>
          <div class="modal-resultado">
            {{ pesoIdealPopup() }} kg
          </div>
        }
        
        <button class="btn-light" (click)="fecharPopup()">Fechar</button>
      </div>
    </div>
  }
</div>

<router-outlet />